#    Copyright 2023 Australian Government Department of 
#    Climate Change, Energy, the Environment and Water
#
#    Licensed under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License.
#    You may obtain a copy of the License at
#
#       https://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS,
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#    See the License for the specific language governing permissions and
#    limitations under the License.
#    
test_that("weibull is unstable", {
  data <- data.frame(Conc = c(868.24508,
                              1713.82388,
                              3161.70678,
                              454.65412,
                              3971.75890,
                              37.69471,
                              262.14053,
                              363.20288,
                              1940.43277,
                              3218.05296,
                              77.48251,
                              1214.70521,
                              1329.27005,
                              1108.05761,
                              339.91458,
                              437.52104))
  
  fits <- ssd_fit_dists(data=data,
                        left = 'Conc', dists = c('gamma', 'weibull'),
                        silent = TRUE, reweight = FALSE, min_pmix = 0, nrow = 6L,
                        computable = TRUE, at_boundary_ok = FALSE, rescale = FALSE)
  
  # not sure why weibull dropping on some linux on github actions and windows
  # on other folks machines
  testthat::skip_on_ci()
  testthat::skip_on_cran()
  expect_identical(names(fits), c('gamma', 'weibull'))
})

test_that("hc multi_ci lnorm default 100", {
  fits <- ssd_fit_dists(ssddata::ccme_boron)
  set.seed(102)
  hc_average <- ssd_hc(fits, average = TRUE, ci = TRUE, nboot = 100, multi_ci = FALSE, multi_est = FALSE, samples = TRUE, weighted = FALSE)
  set.seed(102)
  hc_multi <- ssd_hc(fits, average = TRUE, multi_ci = TRUE, ci = TRUE, nboot = 100,
                     min_pboot = 0.8, samples = TRUE, weighted = FALSE)
  
  testthat::expect_snapshot({
    hc_average
  })
  
  # not sure why hc multi_ci is different on windows
  # ══ Failed tests ════════════════════════════════════════════════════════════════
  # ── Failure ('test-hc-root.R:77:3'): hc multi_ci lnorm default 100 ─────────────────
  # Snapshot of code has changed:
  #   old[4:7] vs new[4:7]
  # # A tibble: 1 x 10
  # dist    percent   est    se   lcl   ucl    wt method     nboot pboot
  # <chr>     <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <chr>      <dbl> <dbl>
  #   -   1 average       5  1.26 0.781 0.331  3.25     1 parametric   100  0.86
  #   +   1 average       5  1.26 0.769 0.410  3.25     1 parametric   100  0.86
  testthat::skip_on_ci() 
  testthat::skip_on_cran()
  testthat::expect_snapshot({
    hc_multi
  })
})

test_that("hp multi_ci lnorm default 100", {
  fits <- ssd_fit_dists(ssddata::ccme_boron)
  set.seed(102)
  hp_average <- ssd_hp(fits, average = TRUE, ci = TRUE, nboot = 100, multi_ci = FALSE, samples = TRUE, weighted = FALSE)
  set.seed(102)
  hp_multi <- ssd_hp(fits, average = TRUE, multi_ci = TRUE, ci = TRUE, nboot = 100,
                     min_pboot = 0.8, samples = TRUE, weighted = FALSE)
  
  testthat::expect_snapshot({
    hp_average
  })
  testthat::skip_on_ci() 
  testthat::skip_on_cran()
  # ── Failure ('test-hp-root.R:79:3'): hp multi_ci lnorm default 100 ─────────────────
  # Snapshot of code has changed:
  #   old[4:7] vs new[4:7]
  # # A tibble: 1 x 10
  # dist     conc   est    se   lcl   ucl    wt method     nboot pboot
  # <chr>   <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <chr>      <dbl> <dbl>
  #   -   1 average     1  3.90  3.57 0.347  11.2     1 parametric   100  0.86
  #   +   1 average     1  3.90  2.89 0.347  11.2     1 parametric   100  0.86
  testthat::expect_snapshot({
    hp_multi
  })
})

test_that("gamma parameters are extremely unstable", {
  data <- ssddata::ccme_boron
  data$Other <- data$Conc
  data$Conc <- data$Conc / max(data$Conc)
  
  # gamma shape change from 913 to 868 on most recent version
  set.seed(102)
  fits <- ssd_fit_dists(data, dists = c("lnorm", "gamma"), right = "Other", rescale = FALSE, computable = FALSE)
  
  tidy <- tidy(fits)
  expect_s3_class(tidy, "tbl")
  testthat::skip_on_ci() # not sure why gamma shape is 908 on GitHub actions windows and 841 on GitHub actions ubuntu
  testthat::skip_on_cran()
  expect_snapshot_data(tidy, "tidy_gamma_unstable", digits = 1)
})


test_that("sgompertz completely unstable!", {
  skip_on_ci() # as incredibly unstable
  skip_on_cran()
  x <- c(
    3.15284072848962, 1.77947821504531, 0.507778085984185, 1.650387414067,
    1.00725113964435, 7.04244885481452, 1.32336941144339, 1.51533791792454
  )
  data <- data.frame(left = x, right = x, weight = 1)
  set.seed(94)
  expect_equal(ssdtools:::sgompertz(data),
               list(log_location = -0.8097519, log_shape = -301.126),
               tolerance = 1e-06
  )
  set.seed(99)
  expect_equal(
    ssdtools:::sgompertz(data),
    list(log_location = -0.96528645818605, log_shape = -2.6047441710778)
  )
  set.seed(100)
  expect_error(ssdtools:::sgompertz(data))
})

test_that("sgompertz with initial values still unstable!", {
  skip_on_ci() # as incredibly unstable
  skip_on_cran()
  x <- c(
    3.15284072848962, 1.77947821504531, 0.507778085984185, 1.650387414067,
    1.00725113964435, 7.04244885481452, 1.32336941144339, 1.51533791792454
  )
  data <- data.frame(Conc = x)
  set.seed(11)
  expect_error(expect_warning(
    fit <- ssd_fit_dists(data, dists = "gompertz"),
    "Some elements in the working weights variable 'wz' are not finite"
  ))
  set.seed(21)
  expect_error(expect_warning(
    fit <- ssd_fit_dists(data, dists = "gompertz"),
    "L-BFGS-B needs finite values of 'fn'"
  ))
  set.seed(10)
  fit <- ssd_fit_dists(data, dists = "gompertz")
  
  sdata <- data.frame(left = x, right = x, weight = 1)
  pars <- estimates(fit$gompertz)
  
  set.seed(94)
  expect_equal(ssdtools:::sgompertz(sdata),
               list(log_location = -0.809751972284548, log_shape = -301.126),
               tolerance = 1e-06
  )
  set.seed(94)
  expect_equal(
    ssdtools:::sgompertz(sdata, pars),
    list(log_location = 4.06999915669631, log_shape = -2936.08880499417)
  )
  set.seed(99)
  expect_equal(
    ssdtools:::sgompertz(sdata),
    list(log_location = -0.96528645818605, log_shape = -2.6047441710778)
  )
  set.seed(99)
  expect_equal(
    ssdtools:::sgompertz(sdata, pars),
    list(log_location = 3.42665325399873, log_shape = -102.775579919568)
  )
  set.seed(100)
  expect_error(ssdtools:::sgompertz(sdata))
  set.seed(100)
  expect_equal(
    ssdtools:::sgompertz(sdata, pars),
    list(log_location = 3.80715953030506, log_shape = -658.432910074053)
  )
})

test_that("ssd_hc cis with error", {
  skip_on_ci()
  skip_on_cran()
  
  set.seed(99)
  conc <- ssd_rlnorm_lnorm(30, meanlog1 = 0, meanlog2 = 1, sdlog1 = 1 / 10, sdlog2 = 1 / 10, pmix = 0.2)
  data <- data.frame(Conc = conc)
  fit <- ssd_fit_dists(data, dists = "lnorm_lnorm", min_pmix = 0.1)
  expect_identical(attr(fit, "min_pmix"), 0.1)
  expect_warning(hc_err <- ssd_hc(fit, ci = TRUE, min_pboot = 0.99, nboot = 100))
  expect_s3_class(hc_err, "tbl")
  expect_snapshot_data(hc_err, "hc_err_na")
  hc_err <- ssd_hc(fit, ci = TRUE, nboot = 100, min_pboot = 0.92, multi_ci = FALSE)
  expect_s3_class(hc_err, "tbl")
  expect_snapshot_data(hc_err, "hc_err")
})

test_that("ssd_hc comparable parametric and non-parametric big sample size", {
  skip_on_ci()
  skip_on_cran()
  
  set.seed(99)
  data <- data.frame(Conc = ssd_rlnorm(10000, 2, 1))
  fit <- ssd_fit_dists(data, dists = "lnorm")
  set.seed(10)
  hc_para <- ssd_hc(fit, ci = TRUE, nboot = 10, multi_ci = FALSE, samples = TRUE, weighted = FALSE)
  expect_snapshot_data(hc_para, "hc_para")
  set.seed(10)
  hc_nonpara <- ssd_hc(fit, ci = TRUE, nboot = 10, parametric = FALSE, multi_ci = FALSE, samples = TRUE, weighted = FALSE)
  expect_snapshot_data(hc_nonpara, "hc_nonpara")
})

test_that("ssd_hp cis with error", {
  skip_on_ci()
  skip_on_cran()
  
  set.seed(99)
  conc <- ssd_rlnorm_lnorm(30, meanlog1 = 0, meanlog2 = 1, sdlog1 = 1 / 10, sdlog2 = 1 / 10, pmix = 0.2)
  data <- data.frame(Conc = conc)
  fit <- ssd_fit_dists(data, dists = "lnorm_lnorm", min_pmix = 0.1)
  expect_identical(attr(fit, "min_pmix"), 0.1)
  expect_warning(hp_err <- ssd_hp(fit, conc = 1, ci = TRUE, nboot = 100, min_pboot = 0.99))
  expect_s3_class(hp_err, "tbl")
  expect_snapshot_data(hp_err, "hp_err_na")
  hp_err <- ssd_hp(fit, conc = 1, ci = TRUE, nboot = 100, min_pboot = 0.92, multi_ci = FALSE, weighted = FALSE)
  expect_s3_class(hp_err, "tbl")
  expect_snapshot_data(hp_err, "hp_err")
})

test_that("ssd_hp comparable parametric and non-parametric big sample size", {
  skip_on_ci()
  skip_on_cran()
  
  set.seed(99)
  data <- data.frame(Conc = ssd_rlnorm(10000, 2, 1))
  fit <- ssd_fit_dists(data, dists = "lnorm")
  set.seed(10)
  hp_para <- ssd_hp(fit, 1, ci = TRUE, nboot = 10, multi_ci = FALSE, samples = TRUE, weighted = FALSE)
  expect_snapshot_data(hp_para, "hp_para")
  set.seed(10)
  hp_nonpara <- ssd_hp(fit, 1, ci = TRUE, nboot = 10, parametric = FALSE, multi_ci = FALSE, samples = TRUE, weighted = FALSE)
  expect_snapshot_data(hp_nonpara, "hp_nonpara")
})

test_that("plot geoms", {
  skip_on_ci()
  skip_on_cran()
  
  gp <- ggplot2::ggplot(boron_pred) +
    geom_ssdpoint(data = ssddata::ccme_boron, ggplot2::aes(x = Conc)) +
    geom_ssdsegment(data = ssddata::ccme_boron, ggplot2::aes(x = Conc, xend = Conc * 2)) +
    geom_hcintersect(xintercept = 100, yintercept = 0.5) +
    geom_xribbon(
      ggplot2::aes(xmin = lcl, xmax = ucl, y = proportion),
      alpha = 1 / 3
    )
  expect_snapshot_plot(gp, "geoms_all")
})


test_that("ssd_plot censored data", {
  skip_on_ci()
  skip_on_cran()
  
  data <- ssddata::ccme_boron
  data$Other <- data$Conc * 2
  expect_snapshot_plot(ssd_plot(data, boron_pred, right = "Other", ribbon = TRUE), "boron_cens_pred_ribbon")
})

test_that("invpareto with extreme data", {
  skip_on_ci()
  skip_on_cran()

  data <- data.frame(Conc = c(
    2.48892649039671, 2.5258371156749, 2.51281264491458,
    2.49866046657748, 2.56572740160664, 2.49440006912093, 2.4817062813665,
    2.47546618759501, 2.53571697416386, 2.50242492575677, 2.50112253589808,
    2.5287786019635, 2.57780684900776, 2.53608336578284, 2.58101156958599,
    2.47461770234486, 2.49063194551244, 2.5856619890231, 2.48695693688166,
    2.57378026021983, 2.51235308389976, 2.48522032692049, 2.49973051106759,
    2.53625648406357, 2.51192819101941, 2.48564121012588, 2.47989185141965,
    2.47104478254847, 2.53704987914894, 2.48182203478124, 2.51943279158882,
    2.47875248023764, 2.52955571948405, 2.53413505298479, 2.4857126516631,
    2.55015093854307, 2.50566701101757, 2.5134323318284, 2.49793441210188,
    2.49424215906085, 2.48960347486455, 2.55358332496617, 2.55446292958609,
    2.48210193691792, 2.46945069890001, 2.48557684661491, 2.56460608968987,
    2.53708962699444, 2.48214951933889, 2.54412439394134, 2.59518068845417,
    2.55975671870397, 2.493434223589, 2.53455956396635, 2.49737837236316,
    2.54900643026637, 2.50513718347292, 2.54882879624245, 2.51814393193009,
    2.46420777049251, 2.46410824439861, 2.52375449633473, 2.50472480352834,
    2.47468853687034, 2.49903375287477, 2.51052484516152, 2.52440831022558,
    2.48241564711347, 2.57274003332032, 2.48966764017043, 2.5690823103684,
    2.50354051434315, 2.57783696959855, 2.55278129417344, 2.49091327122561,
    2.4858726676362, 2.50704022976757, 2.60120582374815, 2.48030852436464,
    2.58234455069583, 2.54629314447072, 2.52650700793897, 2.4871602238994,
    2.50569757079671, 2.49183442063104, 2.50165889380711, 2.47934668379978,
    2.47510756679179, 2.53369127110563, 2.46868451852079, 2.61321699644183,
    2.52987952199996, 2.58987810707128, 2.46777896999791, 2.51447342615507,
    2.48618482994608, 2.51794970929166, 2.49716394702713, 2.49218587262049
  ))
  
  fit99 <- ssd_fit_dists(data, dists = "invpareto")
  
  expect_equal(
    estimates(fit99),
    list(invpareto.weight = 1, invpareto.scale = 2.61422138795731, invpareto.shape = 26.0278618888663)
  )
})

test_that("not all estimates if fail", {
  skip_on_ci()
  skip_on_cran()
  
  dir <- withr::local_tempdir()
  
  fit <- ssd_fit_dists(ssddata::ccme_boron, dists = c("lnorm", "lnorm_lnorm"))
  set.seed(49)
  hc <- ssd_hc(fit, nboot = 10, ci = TRUE,
               parametric = TRUE, save_to = dir, min_pboot = 0.8, samples = TRUE)
  expect_snapshot_data(hc, "hc_notallestimates")
  expect_identical(list.files(dir), c("data_000000000_multi.csv", "data_000000001_multi.csv", "data_000000002_multi.csv", 
                                      "data_000000003_multi.csv", "data_000000004_multi.csv", "data_000000005_multi.csv", 
                                      "data_000000006_multi.csv", "data_000000007_multi.csv", "data_000000008_multi.csv", 
                                      "data_000000009_multi.csv", "data_000000010_multi.csv", "estimates_000000000_multi.rds", 
                                      "estimates_000000001_multi.rds", "estimates_000000002_multi.rds", 
                                      "estimates_000000003_multi.rds", "estimates_000000004_multi.rds", 
                                      "estimates_000000005_multi.rds", "estimates_000000006_multi.rds", 
                                      "estimates_000000007_multi.rds", "estimates_000000008_multi.rds",
                                      "estimates_000000009_multi.rds", "estimates_000000010_multi.rds"))
})

test_that("lnorm_lnorm fits anonb", {
  skip_on_ci()
  skip_on_cran()
  
  set.seed(99)
  data <- ssddata::anon_b
  fit <- ssd_fit_dists(data,
                       dists = c("lnorm_lnorm"),
                       at_boundary_ok = FALSE, min_pmix = 0.05
  )
  
  tidy <- tidy(fit)
  expect_snapshot_data(tidy, "tidy_anonb")
  expect_snapshot_plot(ssd_plot(data, predict(fit), ci = FALSE), "plot_anonb")
})

test_that("lnorm_lnorm non-bimodal 1000 data", {
  skip_on_ci()
  skip_on_cran()

  data <- data.frame(Conc = c(
    11.6635934627129, 11.3655834538171, 11.8239438136152, 11.4457330597547, 
    11.2733838979158, 11.6555694734405, 11.6077458629663, 11.6253179146231, 
    11.7565586590195, 11.1887570445131, 11.6730568277929, 11.4120070711133, 
    11.6824326010276, 11.3911357792784, 12.0706441525969, 11.2155412831347, 
    11.3821410267404, 11.3267141623621, 11.6076784146829, 11.3209976317701, 
    11.2959562378299, 11.6786188036454, 11.6046588017454, 11.7499647941354, 
    11.4831512412866, 11.8286883023093, 11.7007855177161, 11.6125285414713, 
    11.4368552322619, 11.677278735656, 11.2591724516819, 11.2122991922597, 
    11.2014592283697, 11.6757643041424, 11.3976039512326, 11.4064992756645, 
    11.6084844857244, 11.2659904100175, 11.4887603755147, 11.3465556328527, 
    11.6709507658488, 11.4442961944266, 11.6860922015911, 11.3337180713638, 
    11.4934336220037, 11.4237641215403, 11.2597374132061, 11.1767350574449, 
    11.5249429055911, 11.2922544242571, 11.3860745867636, 11.5766005475934, 
    11.2628237130449, 11.6146165920334, 11.4175020113036, 11.3195033621875, 
    11.1710952560318, 11.6597792510826, 11.4868152191465, 11.5721318552201, 
    11.6486854013223, 11.6404214031175, 11.4738473838758, 11.0370114162703, 
    11.5306291118776, 11.7547581342576, 11.1729582778396, 11.5752263994969, 
    11.2468730281413, 11.7327251393004, 11.6517053064323, 11.5377269190321, 
    11.7274750442181, 11.8998204906137, 11.6746453028613, 11.7144040978644, 
    11.3885625929466, 11.4727695225601, 11.5211563372212, 11.8779053238367, 
    11.5235380529653, 11.7352073567185, 11.778095222296, 11.5565087399718, 
    11.4303811869928, 11.411039568203, 11.7936208857429, 11.2632318149877, 
    11.4183636452509, 11.5450923312535, 11.5304172016656, 11.3564668458882, 
    11.3097786542072, 11.2559960803643, 11.1900205330239, 11.3179458681654, 
    11.5468393692064, 11.6109598609785, 11.4397968689957, 11.5829306616596, 
    11.4265533991304, 11.4037107783255, 11.6231069350061, 11.4476147809259, 
    11.315857500714, 11.192073498525, 11.1450028934144, 11.4763778673496, 
    11.3303593182416, 11.795851315237, 11.3154135776636, 11.504446981381, 
    11.3686452517911, 11.0681174567049, 11.9482203553029, 11.4990621721172, 
    11.7700827893035, 11.153277291342, 11.4103274908523, 11.362014739247, 
    11.3370793845089, 10.9490041292355, 11.5709887438907, 11.2392472207936, 
    11.4457697378538, 11.5518564381783, 11.1668497234251, 11.660217248224, 
    11.5408481305805, 11.3596525221312, 11.7088443068689, 11.0985982119481, 
    11.6344343224953, 11.5835918466228, 11.6707241606893, 11.4873075231587, 
    11.6871951877657, 11.3561777270116, 11.0926984591504, 11.6670973459339, 
    11.4743776164222, 11.4012126214713, 11.1670799989037, 11.3895862238313, 
    11.4619188035051, 11.7438466838695, 11.7789086710159, 11.8254153257148, 
    11.5350198406344, 11.614146101765, 11.5037937949341, 11.7594749216344, 
    11.7232424558103, 11.4901038034287, 11.457497322123, 11.4701475688988, 
    11.3495747129771, 11.4768364004515, 11.3536264552173, 11.6967872920671, 
    11.5958239935742, 11.8102460795176, 11.5285720139981, 11.5636360422529, 
    11.2391302305836, 11.6400828524342, 11.3649992872627, 11.7739800561355, 
    11.9514605248261, 11.8948860243831, 11.3298148207664, 11.3913235205135, 
    11.2842354326543, 11.5345139189297, 11.0970243900149, 11.7031563986728, 
    11.6634306349493, 11.9092830544344, 11.5869287303179, 11.7564461328616, 
    11.150172788247, 11.4822541140239, 11.4044323999418, 11.7430862177697, 
    11.4674029907269, 11.6087102680844, 11.0224410790094, 11.1429072494759, 
    11.1440714332214, 11.4429296944542, 11.5110545367456, 11.6902834560434, 
    11.975232188303, 11.3484533650323, 11.5902139993436, 11.6936184805547, 
    11.2156665797036, 11.5367845942098, 11.457685987964, 11.326091672857, 
    11.54310696694, 11.6318253757251, 11.4672564829417, 11.2753353731344, 
    11.5442624404976, 11.4998938095082, 11.7680718084146, 11.4432553497958, 
    11.7656381805778, 11.6559051931419, 11.2711880476245, 11.6412415650511, 
    11.5685922662603, 11.5506412075912, 11.3513987873333, 11.3315276655562, 
    11.335640654208, 11.681285272101, 11.5589662365603, 11.1828140877568, 
    11.5312581724757, 11.5432002402202, 11.7912888955701, 11.4905985999693, 
    11.1259591802745, 11.4610350884183, 11.7991160364597, 11.579099060573, 
    11.33449302326, 11.2554336598017, 11.4512378707303, 11.7226621454134, 
    11.3527354290433, 11.6705425125658, 11.5563556191945, 11.7308586023113, 
    11.9851397182973, 11.075885463439, 11.2080718893369, 11.4368799211954, 
    11.5632546318052, 11.6634278624019, 11.318215841977, 11.4880779444713, 
    11.6701760414542, 11.7900454830006, 11.4305509189927, 11.4005711273461, 
    11.493397563551, 11.3671831886506, 11.5455573847742, 11.455219607115, 
    11.3765307074504, 11.5322198186407, 11.7234429342707, 11.4913195141207, 
    11.5800460407405, 11.5015183797711, 11.600345452303, 11.671105482069, 
    11.9009180552352, 11.3047838103508, 11.243053789483, 11.3132995190247, 
    11.1839945545923, 11.5467528309238, 11.4624123336534, 11.4384084755489, 
    11.7624832869299, 11.4972069873588, 11.6718416090489, 11.5565193860913, 
    11.6854937630156, 11.486887701755, 11.2245408284927, 11.4223163757767, 
    11.6183353030888, 11.4781731819334, 11.4180676231011, 11.5222391679401, 
    10.9874586119541, 11.6315015151944, 11.6259231476061, 11.5246942987034, 
    11.3790143669854, 11.6091093097247, 11.8458505048798, 11.3956132241971, 
    11.4334989846648, 12.0107090576645, 11.58889471641, 11.8485588211996, 
    11.6912962865302, 11.3443567873428, 11.4889742885729, 11.7353556032995, 
    11.3458181845925, 11.5360487979571, 11.572996307097, 11.3900889967152, 
    11.3871286159282, 11.6394988106606, 11.6672892268697, 11.2499719224047, 
    11.4355438444653, 11.4146461074679, 11.5830061909034, 11.356416701344, 
    11.5194114268155, 11.4461730977868, 11.7555819598489, 11.757108193106, 
    11.6621065583231, 11.838582610051, 11.7632074437835, 11.3465420858875, 
    11.5844207003211, 11.1705821018384, 11.4142931889118, 11.6952187675352, 
    11.5853093436653, 11.3754738036731, 11.4897478077412, 11.6808486866119, 
    11.7782359379539, 11.4098989033173, 11.5147654815493, 11.9203595355564, 
    11.7863398442806, 11.6085439373772, 11.3748020550406, 11.5107499518156, 
    11.4459430122029, 11.8864880814917, 11.3910504966753, 11.7608068035471, 
    11.2010926856702, 11.2525270439525, 11.6862467158833, 11.732921172069, 
    11.2587015436406, 11.9648080240531, 11.2853204109666, 11.5145507471921, 
    11.4761721195894, 11.3591745195689, 11.6041308327816, 11.8698306010401, 
    11.6899433491951, 11.3939731110365, 11.5342338112757, 11.7752406163456, 
    11.435729513263, 11.3188712646992, 11.3365988682073, 11.6485204521932, 
    11.480686518043, 11.2799874465089, 11.4116754417375, 11.4545426647885, 
    11.5745481350434, 11.1966656568524, 11.6975132142541, 11.6431448445814, 
    11.2517604231283, 11.1486491517404, 11.6991734787903, 11.2241659658642, 
    11.4952691898267, 11.5740123918133, 11.3536512948081, 11.5378236053867, 
    11.5105640641999, 11.8221701602153, 11.2923902515628, 11.53180649897, 
    11.3691594548817, 11.6175646316642, 11.4053269282246, 11.234768393995, 
    11.641542054491, 11.7999676522794, 11.5257062424203, 11.5059110405551, 
    11.6617696764003, 11.3226243854653, 11.4880248762229, 11.7337176970954, 
    11.2155495826891, 11.6517450661497, 11.6021018262328, 11.3877604077526, 
    11.639890502846, 11.7809973315967, 11.3515596489177, 11.3761078301294, 
    11.4971577458201, 11.7264688656258, 11.4937265193511, 12.0486431731611, 
    11.4285135930375, 11.5266970229313, 11.6897298607594, 11.1325756698399, 
    11.3610403083483, 11.271158595137, 11.5987031218919, 11.2413020872383, 
    11.6922042998872, 11.0622291689558, 11.0493045662671, 11.7886726028345, 
    11.356875041002, 11.222682110044, 11.1729481428879, 12.050179976782, 
    11.3691912771854, 11.1729814065191, 11.6134550080208, 11.3668928620368, 
    11.2789813760573, 11.858752849499, 11.1277127982319, 11.2254664041385, 
    11.6425437286932, 11.5189911033846, 11.72792415931, 11.3460373137601, 
    11.4266246813696, 11.6145883108721, 11.4040865639135, 10.9397029690441, 
    11.9355220072695, 11.5659683736315, 11.2595351388416, 11.7264552315149, 
    11.4250232833136, 11.8505002503181, 11.6736025315652, 11.6358341743864, 
    11.4848620300854, 11.0658566253791, 11.7433762718265, 11.368863939374, 
    12.0430882282277, 11.1478992722267, 11.6529116138211, 11.4386231562301, 
    11.4699978508074, 11.3949217618572, 11.4546511662623, 11.6224432553423, 
    11.4421481785793, 11.657180874398, 12.8288174569032, 11.6252568763014, 
    11.491598965489, 11.5122204443171, 11.1946277176765, 11.3371665039755, 
    11.8219395858959, 11.4177551579925, 11.817401786082, 10.9066865497524, 
    11.6292423316714, 11.4345661115386, 11.5146335760661, 11.2164818600078, 
    11.6462007756576, 11.5594553161589, 11.2777294045852, 11.4064561143383, 
    11.403296101097, 11.1942695626537, 11.2069796841188, 11.5108806250445, 
    11.4903700781168, 11.4412637072806, 11.7367046978334, 11.4415759938265, 
    11.461789360977, 11.5025221397458, 11.6741375647481, 11.6318730203337, 
    11.8724788742072, 11.3411139466139, 11.193895333642, 11.5090212617708, 
    11.4766156814582, 11.3025257977669, 11.6887687898236, 11.9785619762261, 
    11.5832745795798, 11.5638848196105, 11.6373626595557, 11.5346618451343, 
    11.8053599896049, 11.7866836352087, 11.6656448470497, 11.6767793846651, 
    11.4386961150224, 11.6601979255714, 11.6835301301195, 11.1916085178821, 
    11.3638143635823, 11.5384570024637, 11.5021355520758, 11.728807679399, 
    10.984378479658, 11.7213214603164, 10.7461781085464, 11.3870533808756, 
    11.6264922619532, 11.5206029097705, 11.3075447476347, 11.5292525213332, 
    11.4474539160496, 11.1784758708234, 11.3896979535097, 11.719541623793, 
    11.6053073443453, 11.518232072859, 11.3712640382737, 11.6098940705145, 
    11.5382560364661, 11.7993666879693, 11.6324840910319, 11.4481893420571, 
    11.541204261907, 11.5773112599797, 11.5737901104302, 11.4341925128839, 
    11.4793732048958, 11.6786469969964, 11.779820125404, 11.531459246292, 
    11.2534419833243, 11.5242285802331, 11.7505344377909, 11.2561748020822, 
    11.4661314501832, 11.4760530705387, 11.4506126062349, 11.3963732165445, 
    11.4312630670097, 11.3557616131191, 11.5823565060607, 11.5363888326256, 
    11.4917903826409, 11.5703392588785, 11.4208903235975, 11.3264983504393, 
    11.4339118777607, 11.6207177601068, 12.0732854180863, 11.3485270565549, 
    11.7214183450559, 11.3500282028636, 11.2190693389911, 11.2069248306124, 
    11.6847250769785, 11.7484631837051, 11.3928718561409, 11.0483431329695, 
    11.0632555553734, 11.3484711276532, 11.3540665678888, 11.424901501236, 
    11.3772438391331, 11.3402755457535, 11.6658488666932, 11.801777190057, 
    11.2024789759482, 11.2178942545725, 11.4553053426658, 11.7871905188347, 
    11.4981479663863, 11.327302970811, 11.4159310930165, 11.5560442202663, 
    11.7365037432332, 11.3378278539107, 11.8208625963249, 11.6497566272874, 
    11.5075152494812, 11.5215250880463, 11.2812669600297, 11.310753285262, 
    11.9620678652502, 11.3590587863734, 11.3898381131715, 11.2529331118846, 
    11.2362185790092, 11.385351174977, 11.5744685353361, 11.4856804686762, 
    11.913912055332, 11.3767849155427, 11.8094735607357, 11.1508024267808, 
    11.8106804361006, 11.5470001967063, 11.3952593838908, 11.2484965135934, 
    11.1152705518813, 11.5389406080853, 11.7634503537939, 11.4291028317061, 
    11.3276572999105, 11.4930118360099, 11.5469649014856, 11.5169350020809, 
    11.3285353226113, 11.2780234904709, 11.440289000834, 11.220111220716, 
    11.6368461254189, 11.3373985461442, 11.5729909942026, 11.5627913514537, 
    11.896010438462, 12.1378927192053, 11.2661668881932, 11.6500397905937, 
    11.9456515880464, 11.6036046289927, 11.2617034688574, 11.2041718173304, 
    11.7846555949065, 11.7468241221256, 11.5711643637382, 11.4605756512852, 
    11.6855846792033, 11.610560314245, 11.4023298726094, 11.5935010737646, 
    11.4794267316669, 11.4177936724899, 11.3170444087192, 11.4297981291346, 
    11.5846912793348, 11.5361273182454, 11.2836990730896, 11.7129292407643, 
    11.3682617291422, 11.5788574326573, 11.3656467657476, 11.4105589568224, 
    11.6329782469737, 11.7741760320124, 11.5877677859266, 11.4614478490663, 
    11.8922989610443, 11.4769174598707, 11.5473094994925, 11.8164122469798, 
    11.3965297469094, 11.7060351811225, 11.9160697996983, 12.2091231955421, 
    11.4513840897352, 11.9190686799799, 11.5716373917844, 11.4552839479779, 
    11.2069385588086, 11.2352938786398, 11.4799962344234, 11.1715703387231, 
    11.5951806551894, 11.4965967805174, 11.9066684684352, 12.085620305792, 
    11.6762460737526, 11.5003622406498, 11.2467259944484, 11.3576209222196, 
    11.5538967776043, 11.6021728438367, 11.4017677191272, 11.6541203471886, 
    11.5179908661979, 11.3731766103249, 11.284667844589, 11.277379710151, 
    11.6083662721441, 11.4137354186957, 10.8955839097348, 11.6128481523168, 
    10.9414889550394, 11.500934449099, 11.4032494506259, 11.3414275766532, 
    11.6103518032939, 11.4489716827269, 11.4521528606091, 11.4586955357924, 
    11.0442737725854, 11.4024077316865, 11.4530826810189, 11.2142229985889, 
    11.3211367494156, 11.7695143207915, 11.6801094326193, 11.378714542138, 
    11.5894285425463, 11.4535592112896, 11.5189077909302, 11.905529468508, 
    11.7308595111171, 11.1561241580823, 11.5396607072055, 11.5670558138667, 
    11.5866534877845, 11.4899696625367, 10.7606650890848, 11.4623034225546, 
    11.4829861663367, 11.531027241558, 11.1284027924671, 11.3789406141285, 
    11.7180842406464, 11.248060386135, 11.8557680503442, 11.4749711791423, 
    11.7731267020686, 11.4451020052469, 11.5536039362763, 11.2295030702308, 
    11.4439680242462, 11.3599366494965, 11.2375779084626, 11.4027090068517, 
    11.4674002049422, 11.6107908879673, 11.3646653036025, 11.3525677125419, 
    11.6956920927681, 11.5949761789213, 11.4279470409673, 11.628194983154, 
    11.3797989564061, 11.4537211190876, 11.544720822699, 11.3477447726164, 
    11.5106910979557, 11.2705155562627, 11.5419354593303, 11.6002427009366, 
    11.3617284216845, 11.4545380023049, 11.5559785868196, 11.2827575037312, 
    11.4923949055435, 11.4670902548463, 11.7775808724294, 11.7524650925602, 
    11.5232395955812, 11.7716348213617, 11.3129441491383, 11.9184159519933, 
    11.4651302298193, 11.4828115364529, 11.4921553448102, 11.4840394509425, 
    11.4795329119155, 11.3557617727837, 11.1990802135024, 11.555895890632, 
    11.5665334157256, 11.9608405697218, 11.0906137231452, 11.4738335300962, 
    11.5552267798845, 11.4917532448646, 11.4767501205378, 11.309257136722, 
    11.8330397760739, 11.2452007264035, 11.5626653665188, 11.6615348431299, 
    11.4036383205713, 11.9206466284402, 11.4028117349485, 11.232335830704, 
    11.5710019223606, 11.2323436049941, 11.0986236955492, 11.7618238628064, 
    11.3445348352561, 11.378093136043, 11.5381912190455, 11.282570495449, 
    11.3186759511659, 11.4117838917907, 11.6227635225452, 11.7844213221872, 
    11.5671587969278, 11.458922182513, 11.4032992701995, 11.5491884538217, 
    11.2758671228542, 11.6770897492982, 11.6342313067151, 11.1237574188463, 
    11.6031081273673, 12.1290653063871, 11.4778345922648, 11.3583463804655, 
    11.3266052031506, 11.7246123353123, 11.4647737955044, 11.5883332972292, 
    11.4248310030985, 11.3713918308266, 11.2041509548359, 11.617616628905, 
    11.3759381668148, 11.3305920225639, 11.6871369457011, 11.6303021419011, 
    11.4931674583361, 11.0922966074434, 11.2490842937364, 10.9403583083204, 
    11.1716989237958, 11.4292855836507, 11.6236233194597, 11.5989208423244, 
    11.2147889962406, 11.625607143598, 11.8748838328963, 11.5414934062674, 
    11.6259439615824, 11.3364532857374, 11.8227344400673, 11.7111666222959, 
    11.3727104334305, 11.7078155455392, 11.5544569070194, 11.6021540153749, 
    11.573369065866, 10.8581859655439, 11.6615357936139, 11.6074293122824, 
    11.3800328287919, 11.8608121046055, 10.8695335671074, 11.4549460213617, 
    11.6732793086444, 11.6280582434249, 11.7938110746401, 11.2759355094693, 
    11.7333174374389, 11.5124908292672, 11.5116966042338, 11.2557414497685, 
    11.111003192477, 11.7723687553069, 11.5311536361956, 11.415675250247, 
    11.434958888026, 11.5764304335137, 11.3184428704269, 11.5925005193847, 
    11.6606221243124, 11.6799864503813, 11.6680624812246, 11.6323392171622, 
    11.6205668223306, 11.2743893579799, 11.3038169041637, 11.2516179608122, 
    11.0913550278671, 11.5183036046645, 11.6088540037091, 11.4237385957101, 
    11.7411183714493, 11.5268255736499, 11.5514313428383, 11.4939244996735, 
    11.478671143305, 11.5506137782508, 11.4838342763386, 11.9082590797765, 
    10.960554474782, 11.4510734836701, 11.594720494906, 11.6435287600618, 
    11.4730994130636, 11.6753147493462, 11.0704918909154, 11.3363906264414, 
    11.4069381361204, 11.3390189388972, 11.7394581174949, 11.5025933598415, 
    11.5091568374427, 11.8189657846627, 11.6762535202989, 11.4862855869735, 
    11.5191142470272, 11.4087780398663, 11.5361396738411, 11.3477626341929, 
    11.3295447034612, 11.6461819581215, 11.3160562372171, 11.9732839905477, 
    11.2597545419879, 11.6483236285684, 11.6659329899876, 11.3375985127992, 
    11.5652927769658, 11.5402126667346, 11.5246347656743, 11.3790534415256, 
    11.3504467491437, 11.9006774473653, 11.2998434728114, 11.294215001317, 
    11.0352592725904, 11.5442750193934, 11.9540286929111, 11.5849472177449, 
    11.8695269797079, 11.2221940781463, 11.5391494901798, 11.7652998758852, 
    11.7152214736869, 11.6161349733777, 11.3455362974154, 11.3697013696593, 
    11.6159930311664, 11.5192522836597, 11.3626732407949, 11.7915655615128, 
    10.8468085570926, 11.5051760134024, 11.3931245756523, 11.6445146662936, 
    11.3470732268861, 11.6515019252136, 11.5141257439709, 11.2773011669151, 
    11.3032998105644, 11.7571007839257, 11.3544692125066, 11.5818232930408, 
    11.0839805881239, 11.8582789073051, 11.5997729156958, 11.5897058738691, 
    11.4193569373722, 11.8678858552685, 11.6051915096343, 11.3371558507094, 
    11.3210764775439, 11.3670660935708, 10.9736909230005, 11.5134036283058, 
    11.7378869878075, 11.6101540643963, 11.5960760408688, 11.5398373831802, 
    11.6921293527264, 11.0056293583308, 11.3779618825627, 11.4358858630188, 
    11.3398108548088, 11.500395429923, 11.6290788048495, 11.4534379910937, 
    11.3973526125132, 11.8090228812056, 11.4349697688751, 11.4120105561733, 
    11.2768023713792, 11.6479180048227, 11.8538348852147, 11.2816551787507, 
    11.5483270246353, 11.5002183838825, 11.3020898934751, 11.5115149415805, 
    11.2017560031151, 11.352225955946, 11.6826296693967, 11.8553332139932, 
    11.9042883574032, 11.0560549115389, 11.1767099828818, 11.421709850191, 
    11.702545464272, 11.7485923966285, 11.8047860348248, 11.4448541804893, 
    11.4705435703147, 11.716935272144, 10.9954029806633, 11.1256601239288
  ))
  fit <- ssd_fit_dists(data = data, dists = 'lnorm_lnorm', at_boundary_ok=TRUE)
  tidy <- tidy(fit)
  expect_snapshot_data(tidy, "tidy_lnorm_lnorm_uni1000", digits = 3)
})  

