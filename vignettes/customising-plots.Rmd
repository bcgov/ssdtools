---
title: "Customising Plots"
author: "ssdtools Team"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
bibliography: references.bib
# csl: style.csl
mainfont: Arial
mathfont: Courier
latex_engine: MathJax
output: rmarkdown::html_vignette
#output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Customising Plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 6,
  fig.height = 4
)
```

## Plotting the cumulative distributions

The `ssdtools` package plots the cumulative distribution functions using `ssd_plot_cdf()`. 

For example, consider the CCME boron data from the [`ssddata`](https://github.com/open-AIMS/ssddata) package. 
We can fit, and then plot the cdfs as follows.

```{r warning=FALSE, message=FALSE}
library(ssdtools)
library(ggplot2)

fits <- ssd_fit_dists(ssddata::ccme_boron)
ssd_plot_cdf(fits)
```

This graphic is a [ggplot](https://ggplot2.tidyverse.org) object and so can be customized in the usual way.

For example, we can add the model-averaged cdf by setting `average = NA` and change the string used to separate thousands using `big.mark` then customize the color scale with `scale_color_manual()` and change the theme.

```{r}
ssd_plot_cdf(fits, average = NA, big.mark = " ") + 
  scale_color_manual(name = "Distribution", breaks = c("average", names(fits)), values = 1:7) +
  theme_bw()
```

## ggplot Geoms

The `ssdtools` package provides four ggplot geoms to allow you construct your own plots.

### `geom_ssdpoint()`

The first is `geom_ssdpoint()` which plots species sensitivity data

```{r}
ggplot(ssddata::ccme_boron) +
  geom_ssdpoint(aes(x = Conc)) +
  ylab("Probability density") +
  xlab("Concentration")
``` 

### `geom_ssdsegments()`

The second is `geom_ssdsegments()` which plots the ranges of censored species sensitivity data

```{r}
ggplot(ssddata::ccme_boron) +
  geom_ssdsegment(aes(x = Conc, xend = Conc * 2)) +
  ylab("Probability density") +
  xlab("Concenration")
``` 

### `geom_xribbon()`

The third is `geom_xribbon()` which plots species sensitivity confidence intervals

```{r}
ggplot(boron_pred) +
  geom_xribbon(aes(xmin = lcl, xmax = ucl, y = proportion)) +
  ylab("Probability density") +
  xlab("Concenration")
```  

### `geom_hcintersect()`

And the fourth is `geom_hcintersect()` which plots hazard concentrations

```{r}
ggplot() +
  geom_hcintersect(xintercept = c(1, 2, 3), yintercept = c(0.05, 0.1, 0.2)) +
  ylab("Probability density") +
  xlab("Concenration")
```    

### Combining geoms

Geoms can be combined together as follows

```{r}
gp <- ggplot(boron_pred, aes(x = est)) +
  geom_xribbon(aes(xmin = lcl, xmax = ucl, y = proportion), alpha = 0.2) +
  geom_line(aes(y = proportion)) +
  geom_ssdsegment(data = ssddata::ccme_boron, aes(x = Conc / 2, xend = Conc * 2)) +
  geom_ssdpoint(data = ssddata::ccme_boron, aes(x = Conc / 2)) +
  geom_ssdpoint(data = ssddata::ccme_boron, aes(x = Conc * 2)) +
  scale_y_continuous("Species Affected (%)", labels = scales::percent) +
  expand_limits(y = c(0, 1)) +
  xlab("Concentration (mg/L)")

print(gp)
```

To log the x-axis and add the HC5 value use the following code.

```{r}
gp + 
  coord_trans(x = "log10") +
  scale_x_continuous(
    breaks = scales::trans_breaks("log10", function(x) 10^x),
    labels = ssd_label_comma()
  ) +
  geom_hcintersect(xintercept = ssd_hc(fits)$est, yintercept = 0.05)
```

## Saving plots

The most recent plot can be saved as a file using `ggsave()`, which also allows the user to set the resolution.

```r
ggsave("file_name.png", dpi = 600)
```

## Fitting and plotting distributions to multiple groups such taxa and/or chemicals

An elegant approach using some tidyverse packages is demonstrated below.

```{r, message=FALSE}

boron_preds <- tidyr::nest(ssddata::ccme_boron, data = c(Chemical, Species, Conc, Units)) |>
  dplyr::mutate(
    Fit = purrr::map(data, ssd_fit_dists, dists = "lnorm"),
    Prediction = purrr::map(Fit, predict)
  ) |>
  tidyr::unnest(Prediction)
```

The resultant data and predictions can then be plotted as follows.

```{r}
library(ssdtools)
library(ssddata)
ssd_plot(ssddata::ccme_boron, boron_preds, xlab = "Concentration (mg/L)", ci = FALSE) +
  facet_wrap(~Group)
```

## References

<div id="refs"></div>

```{r, results = "asis", echo = FALSE}
cat(ssdtools::ssd_licensing_md())
```
